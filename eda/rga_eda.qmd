---
title: "rga eda"
format: html
---

```{r}
library(tidyverse)
library(arrow)
library(plotly)
library(gemstools)
library(suntools)
library(patchwork)

source("bin_timeseries.R")
data_dir <- "data/processed/lander/"
```

```{r}
df <- open_dataset("data/processed/landergems_rga/rga.parquet")
bad_times <- read_csv("data/2025_Hadleys_Harbor/gems_2025_bad_data_periods.csv")
```


```{r}
df_wide <- df |> 
  collect() |> 
  process_rga_to_wide()
```

Remove bad data periods and normalize by argon

```{r}
df_wide_cl <- df_wide |> 
  anti_join(bad_times, by = join_by(timestamp >= start_time, timestamp <= end_time)) |>
  mutate(
    across(starts_with("mass_"), ~ .x / mass_40, .names = "{.col}_40")
  )
```


```{r}
df_binned <- bin_timeseries(
  df_wide_cl,
  datetime_col = "timestamp",
  value_cols = c(
    "mass_15_40",
    "mass_28_40",
    "mass_32_40",
    "mass_44_40"
  )
)
    
```

```{r}
e <- ggplot(df_binned, aes(bin_time, mass_32_40, color = inlet)) +
  geom_line()

p <- ggplotly(e, dynamicTicks = TRUE)
p
```

```{r}
e <- ggplot(df_binned, aes(bin_time, mass_44_40, color = inlet)) +
  geom_line()

p <- ggplotly(e, dynamicTicks = TRUE)
p
```

Make one row for each high-low pair

```{r}
df_binned_wide <- df_binned |>
  group_by(grp = cumsum(inlet == "high")) |>
  mutate(mean_timestamp = mean(bin_time)) |>
  ungroup() |>
  pivot_wider(
    id_cols = c(grp, mean_timestamp),
    names_from = inlet,
    values_from = starts_with("mass_"),
    names_sep = "_"
  ) |>
  select(-grp) |>
  mutate(
    timestamp = lubridate::round_date(mean_timestamp, unit = "15 minutes"),
    across(ends_with("_high"), 
             \(x) (x + get(sub("_high$", "_low", cur_column()))) / 2, 
             .names = "{.col}_mean"),
    across(ends_with("_high"), 
             \(x) x - get(sub("_high$", "_low", cur_column())), 
             .names = "{.col}_diff"),
  ) |> 
  dplyr::relocate(timestamp, .before = dplyr::everything())
```

generate PAR data

```{r}
crds <- matrix(c(-70.7003, 41.51875), nrow = 1)

# calculate predicted par from solar azimuth
pred_par <- function(crds, timestamp) {
  altitude <- solarpos(crds, timestamp)[,2]
  altitude <- replace(altitude, altitude <= 0, 0)
  insolation = sin(altitude * pi / 180)
  par = 0.45 * insolation * 4.6 * 1000
  par
}    

df_binned_wide <- df_binned_wide |> 
  mutate(par = pred_par(crds, timestamp))
```

Difference plots

```{r}
e <- ggplot(df_binned_wide, aes(timestamp, mass_32_40_high_diff)) +
  geom_line()

f <- ggplot(df_binned_wide, aes(timestamp, par)) +
  geom_line()

# Convert to interactive plotly
p1_pl <- ggplotly(e, dynamicTicks = TRUE)
p2_pl <- ggplotly(f, dynamicTicks = TRUE)

subplot(p1_pl, p2_pl, nrows = 2, shareX = TRUE, titleY = TRUE, heights = c(0.5, 0.5))
```

```{r}
e <- ggplot(df_binned_wide, aes(timestamp, mass_44_40_high_diff)) +
  geom_line()

p <- ggplotly(e, dynamicTicks = TRUE)
p
```


# calibration

## oxygen

read seaphox data, aggregate to 15 min avg and fit to GEMS data

TODO: add september seaphox

```{r}

seaphox_df_jul <- data.table::fread("data/2025_Hadleys_Harbor/seaphox/Shallow SeapHox2-0000453-Data-20250716T200119.csv") |> 
  janitor::clean_names() |> 
  mutate(timestamp = lubridate::mdy_hms(date_time_utc_00_00,
                          tz = "UTC")) |>
  select(timestamp,
           pH = internal_p_h_p_h,
           temp = p_h_temperature_celsius,
           pressure = pressure_decibar,
           sal = salinity_psu,
           oxygen = oxygen_ml_l) |> 
  filter(timestamp > "2025-07-12 00:00:00",
         timestamp <= "2025-07-16 14:00:00")
         
```

```{r}
ggplot(seaphox_df_jul, aes(timestamp, oxygen)) +
  geom_line()
```

```{r}
ggplot(seaphox_df_jul, aes(timestamp, sal)) +
  geom_line()

```

```{r}

seaphox_df_sep <- data.table::fread("data/2025_Hadleys_Harbor/seaphox/Shallow SeapHox2-0000453-Data-20250916T181837.csv") |> 
  janitor::clean_names() |> 
  mutate(timestamp = lubridate::mdy_hms(date_time_utc_00_00,
                          tz = "UTC")) |>
  select(timestamp,
           pH = internal_p_h_p_h,
           temp = p_h_temperature_celsius,
           pressure = pressure_decibar,
           sal = salinity_psu,
           oxygen = oxygen_ml_l) #|> 
 # filter(timestamp > "2025-07-12 00:00:00",
  #       timestamp <= "2025-07-16 14:00:00")
         
```

```{r}
ggplot(seaphox_df_sep, aes(timestamp, oxygen)) +
  geom_line()
```

```{r}
 # aggregate seaphox to nearest minute
  sp_m <- seaphox_df_jul %>%
    mutate(timestamp = lubridate::floor_date(timestamp, "15 minute")) |>
    dplyr::group_by(timestamp) |>
    dplyr::summarise(seaphox_oxy = mean(oxygen))

  joined_data <- dplyr::inner_join(sp_m, df_binned_wide, by = dplyr::join_by(timestamp))

  o2_lm <- lm(seaphox_oxy ~ mass_32_40_high_mean, data = joined_data)
  coef(o2_lm)
```

```{r}
joined_data |>
  pivot_longer(
    cols = c(seaphox_oxy, mass_32_40_high_mean),
    names_to = "source",
    values_to = "value"
  ) |>  ggplot(aes(timestamp, value, color = source)) +
  geom_line()

```


fit oxygen

```{r}
ox_i = coef(o2_lm)[1]
ox_m = coef(o2_lm)[2]
df_binned_wide <- df_binned_wide |> 
  mutate(oxygen_high = ox_i + ox_m * mass_32_40_high,
         oxygen_low = ox_i + ox_m * mass_32_40_low)
```

```{r}
e <- df_binned_wide |>
  select(timestamp, oxygen_high, oxygen_low) |> 
  pivot_longer(
    cols = c(oxygen_high, oxygen_low),
    names_to = "inlet",
    values_to = "oxygen") |> 
    ggplot(aes(timestamp, oxygen, color = inlet)) +
  geom_line()

p <- ggplotly(e, dynamicTicks = TRUE)
p
```

## Carbon dioxide

```{r}
co2_df <- read_prooceanus("data/2025_Hadleys_Harbor/prooceanus/prooceanus_co2_gems_hadley_2025-08-19.txt")

co2_df_res <- co2_df |> 
  filter(ts >= as.Date("2025-07-17 20:50:00"),
         ts <= as.Date("2025-08-03")) |> 
  mutate(ts = floor_date(ts, unit = "15 mins")) |>
  group_by(ts) |>
  summarize(co2 = mean(co2, na.rm = TRUE))
```



```{r}
co2p <- ggplot(co2_df_res, aes(x =ts, y = co2)) +
  #geom_point() +
  geom_line() +
  labs(
    title = "ProOceanus CO2 Data",
    x = "Date",
    y = "CO2 (ppm)"
  ) +
  theme_minimal()

ggplotly(co2p)
```

```{r}
tar_load(proco2_df_jul)
co2p <- ggplot(proco2_df_jul, aes(x =ts, y = co2)) +
  #geom_point() +
  geom_line() +
  labs(
    title = "ProOceanus CO2 Data",
    x = "Date",
    y = "CO2 (ppm)"
  ) +
  theme_minimal()

ggplotly(co2p)
```

```{r}
co2_df_res <- co2_df_res |> 
  rename(timestamp = ts,
         prooceanus_co2 = co2)

co2_j <- dplyr::inner_join(co2_df_res, df_binned_wide, by = dplyr::join_by(timestamp))

co2_lm <- lm(prooceanus_co2 ~ mass_44_40_high_mean, data = co2_j)
coef(co2_lm)
```

fit CO2

```{r}
co2_i = coef(co2_lm)[1]
co2_m = coef(co2_lm)[2]
df_binned_wide <- df_binned_wide |> 
  mutate(co2_high = co2_i + co2_m * mass_44_40_high,
         co2_low = co2_i + co2_m * mass_44_40_low)
```

```{r}
e <- df_binned_wide |>
  select(timestamp, co2_high, co2_low) |> 
  pivot_longer(
    cols = c(co2_high, co2_low),
    names_to = "inlet",
    values_to = "co2") |> 
    ggplot(aes(timestamp, co2, color = inlet)) +
  geom_line()

p <- ggplotly(e, dynamicTicks = TRUE)
p
```


```{r}
df_p <- df_binned_wide |> 
  mutate(
    ox = oxygen_low - oxygen_high,
    co2 = co2_low - co2_high) |> 
  select(timestamp, ox, co2)

ox_p <- ggplot(df_p, aes(timestamp, ox)) +
  geom_line() +
  labs(
    #title = "Oxygen Difference (Low - High)",
    x = "Timestamp",
    y = "Oxygen Difference (ml/L)"
  ) +
  theme_minimal()

co2_p <- ggplot(df_p, aes(timestamp, co2)) +
  geom_line() +
  labs(
    #title = "CO2 Difference (Low - High)",
    x = "Timestamp",
    y = "CO2 Difference (ppm)"
  ) +
  theme_minimal()

par_p <- ggplot(df_binned_wide, aes(timestamp, par)) +
  geom_line() +
  labs(
    #title = "Predicted PAR",
    x = "Timestamp",
    y = "PAR (µmol/m²/s)"
  ) +
  theme_minimal()

ox_ply <- ggplotly(ox_p, dynamicTicks = TRUE)
co2_ply <- ggplotly(co2_p, dynamicTicks = TRUE)
par_ply <- ggplotly(par_p, dynamicTicks = TRUE)

subplot(ox_ply, co2_ply, par_ply, nrows = 3, shareX = TRUE, titleY = TRUE, heights = c(0.4, 0.4, 0.2))
```

# Data output

write out RGA data

```{r}
write_parquet(df_binned_wide, "data/processed/lander/rga_calibrated.parquet")
```

Combine with velocity data and write to parquet

```{r}
adv_df <- open_dataset("data/processed/lander/adv_bin_rot.parquet") |> 
  collect()
```

bin velocity data to 15 min bins

```{r}
adv_bin <- adv_df |>
  group_by(grp = cumsum(inlet == "high")) |>
  summarize(
    mean_timestamp = mean(bin_time),
    timestamp = lubridate::round_date(mean_timestamp, unit = "15 minutes"),
    across(c(pressure, cur_speed, cur_dir, u_rot, v_rot, w_rot), \(x) mean(x))
  ) |> 
  dplyr::relocate(timestamp, .before = dplyr::everything())
```

```{r}
adv_select <- adv_bin |> 
  select(timestamp,
         pressure,
         cur_speed,
         cur_dir,
         u = u_rot,
         v = v_rot,
         w = w_rot)
```

join to rga

```{r}
df_all <- df_binned_wide |> 
  left_join(adv_select, by = join_by(timestamp)) |> 
  drop_na()
```

add temp from status file

```{r}
status_df <- open_dataset("data/processed/lander/gems_status.parquet") |> 
  select(timestamp, temp) |> 
  collect() |>  
  mutate(timestamp = lubridate::floor_date(timestamp, unit = "15 minutes")) |> 
  group_by(timestamp) |> 
  summarize(temp = mean(temp, na.rm = TRUE))
```

```{r}
df_all <- df_all |> 
  left_join(status_df, by = join_by(timestamp))
```

remove bad times


```{r}
df_all <- df_all |> 
  anti_join(bad_times, by = join_by(timestamp >= start_time, timestamp <= end_time))
```


```{r}
df_p <- df_all |> 
  mutate(
    ox = oxygen_low - oxygen_high,
    co2 = co2_low - co2_high) |> 
  select(timestamp, ox, co2, par, cur_speed, cur_dir, w)

ox_p <- ggplot(df_p, aes(timestamp, ox)) +
  geom_line() +
  labs(
    #title = "Oxygen Difference (Low - High)",
    x = "Timestamp",
    y = "Oxygen Difference (ml/L)"
  ) +
  theme_minimal()

co2_p <- ggplot(df_p, aes(timestamp, co2)) +
  geom_line() +
  labs(
    #title = "CO2 Difference (Low - High)",
    x = "Timestamp",
    y = "CO2 Difference (ppm)"
  ) +
  theme_minimal()

cur_p <- ggplot(df_p, aes(timestamp, cur_speed)) +
  geom_line() +
  labs(
    #title = "Predicted PAR",
    x = "Timestamp",
    y = "Horizontal speed"
  ) +
  theme_minimal()

dir_p <- ggplot(df_p, aes(timestamp, cur_dir)) +
  geom_line() +
  labs(
    #title = "Predicted PAR",
    x = "Timestamp",
    y = "Horizontal dir"
  ) +
  theme_minimal()

par_p <- ggplot(df_p, aes(timestamp, par)) +
  geom_line() +
  labs(
    #title = "Predicted PAR",
    x = "Timestamp",
    y = "PAR (µmol/m²/s)"
  ) +
  theme_minimal()

ox_ply <- ggplotly(ox_p, dynamicTicks = TRUE)
co2_ply <- ggplotly(co2_p, dynamicTicks = TRUE)
cur_ply <- ggplotly(cur_p, dynamicTicks = TRUE)
dir_ply <- ggplotly(dir_p, dynamicTicks = TRUE)
par_ply <- ggplotly(par_p, dynamicTicks = TRUE)

subplot(ox_ply, co2_ply, cur_ply, dir_ply, par_ply,
        nrows = 5, shareX = TRUE, titleY = TRUE
)
```

convert ox to umol/l

```{r}
df_all <- df_all |> 
  mutate(
    ox_high_umol_l = o2_ml_l_to_umol_l(oxygen_high, temp),
    ox_low_umol_l = o2_ml_l_to_umol_l(oxygen_low, temp)
  )

```

add oxygen mean and gradient

```{r}
df_all <- df_all |> 
  mutate(
    ox_mean_umol_l = (ox_low_umol_l + ox_high_umol_l) / 2,
    ox_gradient_umol_l_m = (ox_low_umol_l - ox_high_umol_l) / 1.02 # sensor separation in meters
  )
```

### hourly concentration and gradient

```{r}

sol_noon = solarnoon(crds, df_all$timestamp, POSIXct.out = TRUE)
mean(sol_noon) # about 16800 seconds

# calculate difference from solar noon in hours
# NOT USED
time_before_after_noon <- function(ts, solar_noon) {
  # difftime returns an object with units; convert to numeric seconds
  d <- as.numeric(difftime(ts, solar_noon, units = "secs"))
  # Wrap to (-12h, +12h]: use modulo with 24h, then shift into desired interval
  day_secs <- 24 * 3600
  half_day <- 12 * 3600
  wrapped <- ((d + half_day) %% day_secs) - half_day
  as.numeric(wrapped) / 3600  # convert back to hours
}

df_all_hourly <- df_all |> 
  mutate(
    hour = hour(timestamp),
    diff_noon = timestamp - 16800,
    solar_hour = hour(diff_noon)
  ) |> 
  group_by(solar_hour) |> 
  summarize(
    ox_mean_umol_l_hourly = mean(ox_mean_umol_l, na.rm = TRUE),
    ox_mean_umol_l_hourly_sd = sd(ox_mean_umol_l, na.rm = TRUE),
    ox_gradient_umol_l_m_hourly = mean(ox_gradient_umol_l_m, na.rm = TRUE),
    ox_gradient_umol_l_m_hourly_sd = sd(ox_gradient_umol_l_m, na.rm = TRUE)
  )
```

plot

```{r}
hmp <- df_all_hourly |> 
  ggplot(aes(solar_hour, ox_mean_umol_l_hourly)) +
  geom_line() +
  geom_ribbon(aes(ymin = ox_mean_umol_l_hourly - ox_mean_umol_l_hourly_sd,
                  ymax = ox_mean_umol_l_hourly + ox_mean_umol_l_hourly_sd),
              alpha = 0.2) +
  labs(x = NULL,
       y = "Oxygen Conc. [mmol/m3]")

hgp <- df_all_hourly |> 
  ggplot(aes(solar_hour, ox_gradient_umol_l_m_hourly)) +
  geom_line() +
  geom_ribbon(aes(ymin = ox_gradient_umol_l_m_hourly - ox_gradient_umol_l_m_hourly_sd,
                  ymax = ox_gradient_umol_l_m_hourly + ox_gradient_umol_l_m_hourly_sd),
              alpha = 0.2) +
  labs(x = "Hour of Day",
       y = "Oxygen Gradient [mmol/m4]")

hmp / hgp
# hm_ply <- ggplotly(hmp, dynamicTicks = TRUE)
# hg_ply <- ggplotly(hgp, dynamicTicks = TRUE)
# subplot(hm_ply, hg_ply, nrows = 2, shareX = TRUE, titleY = TRUE)
```

write out dataset

```{r}
write_parquet(df_all, "data/processed/lander/rga_adv_calibrated.parquet")
```

```{r}
df_all = open_dataset(file.path(data_dir, "rga_adv_calibrated.parquet"))
```

Import Ustar data derived from CPSD ADV calc

```{r}
flux_ustar <- open_dataset(file.path(data_dir, "gems_flux_8hz_rot2.parquet")) |>
  collect() |>
  select(timestamp, Ustar) |>
  mutate(timestamp = lubridate::floor_date(timestamp, unit = "15 minutes")) |>
  group_by(timestamp) |>
  summarize(Ustar = mean(Ustar, na.rm = TRUE))

df_all_ustar <- df_all |>
  left_join(flux_ustar, by = join_by(timestamp))
```

```{r}
tar_load(flux_dataset)
flux_ustar <- flux_dataset |>
  collect() |>
  select(timestamp, Ustar) |>
  mutate(timestamp = lubridate::floor_date(timestamp, unit = "15 minutes"),
         timestamp = lubridate::with_tz(timestamp, "UTC")) |>
  group_by(timestamp) |>
  summarize(Ustar = mean(Ustar, na.rm = TRUE))

df_all_ustar <- df_all |>
  left_join(flux_ustar, by = join_by(timestamp))
```

Calculate gradient flux

Using a placeholder length scale based on adv height


```{r}
df_flux = df_all_ustar |>
  mutate(lscale = 0.3,
         ox_flux = -1 * Ustar * lscale * (ox_gradient_umol_l_m))
```


```{r}
gp = ggplot(collect(df_flux), aes(timestamp, ox_flux)) + 
geom_line()

ggplotly(gp, dynamicTicks = TRUE)
```

```{r}
tar_load(rga_adv_flux)
```

```{r}
gop = ggplot(rga_adv_flux, aes(timestamp, ox_flux)) + 
geom_line()

gcp = ggplot(rga_adv_flux, aes(timestamp, co2_flux)) + 
geom_line()

gpp = ggplot(rga_adv_flux, aes(timestamp, par)) + 
geom_line()

gop_ply <- ggplotly(gop, dynamicTicks = TRUE)
gcp_ply <- ggplotly(gcp, dynamicTicks = TRUE)
gpp_ply <- ggplotly(gpp, dynamicTicks = TRUE)

subplot(gop_ply, gcp_ply, gpp_ply, nrows = 3, shareX = TRUE, titleY = TRUE)
```

hourly concentration, gradient, flux

### hourly concentration and gradient

```{r}

sol_noon = solarnoon(crds, rga_adv_flux$timestamp, POSIXct.out = TRUE)
mean(sol_noon) # about 16800 seconds

# calculate difference from solar noon in hours
# NOT USED
time_before_after_noon <- function(ts, solar_noon) {
  # difftime returns an object with units; convert to numeric seconds
  d <- as.numeric(difftime(ts, solar_noon, units = "secs"))
  # Wrap to (-12h, +12h]: use modulo with 24h, then shift into desired interval
  day_secs <- 24 * 3600
  half_day <- 12 * 3600
  wrapped <- ((d + half_day) %% day_secs) - half_day
  as.numeric(wrapped) / 3600  # convert back to hours
}

df_flux_hourly <- rga_adv_flux |> 
  mutate(
    hour = hour(timestamp),
    diff_noon = timestamp - 16800,
    solar_hour = hour(diff_noon)
  ) |> 
  group_by(solar_hour) |> 
  summarize(
    ox_mean_umol_l_hourly = mean(ox_mean_umol_l, na.rm = TRUE),
    ox_mean_umol_l_hourly_sd = sd(ox_mean_umol_l, na.rm = TRUE),
    ox_gradient_umol_l_m_hourly = mean(ox_gradient_umol_l_m, na.rm = TRUE),
    ox_gradient_umol_l_m_hourly_sd = sd(ox_gradient_umol_l_m, na.rm = TRUE),
    ox_flux_hourly = mean(ox_flux, na.rm = TRUE),
    ox_flux_hourly_sd = sd(ox_flux, na.rm = TRUE)
  )
```

plot

```{r}
hmp <- df_flux_hourly |> 
  ggplot(aes(solar_hour, ox_mean_umol_l_hourly)) +
  geom_line() +
  geom_ribbon(aes(ymin = ox_mean_umol_l_hourly - ox_mean_umol_l_hourly_sd,
                  ymax = ox_mean_umol_l_hourly + ox_mean_umol_l_hourly_sd),
              alpha = 0.2) +
  labs(x = NULL,
       y = "Oxygen Conc. [mmol/m3]")

hgp <- df_flux_hourly |> 
  ggplot(aes(solar_hour, ox_gradient_umol_l_m_hourly)) +
  geom_line() +
  geom_ribbon(aes(ymin = ox_gradient_umol_l_m_hourly - ox_gradient_umol_l_m_hourly_sd,
                  ymax = ox_gradient_umol_l_m_hourly + ox_gradient_umol_l_m_hourly_sd),
              alpha = 0.2) +
  labs(x = "Hour of Day",
       y = "Oxygen Gradient [mmol/m4]")

flp <- df_flux_hourly |> 
  ggplot(aes(solar_hour, ox_flux_hourly)) +
  geom_line() +
  geom_ribbon(aes(ymin = ox_flux_hourly - ox_flux_hourly_sd,
                  ymax = ox_flux_hourly + ox_flux_hourly_sd),
              alpha = 0.2) +
  labs(x = "Hour of Day",
       y = "Oxygen Flux [mmol/m2]")

hmp / hgp / flp

# hm_ply <- ggplotly(hmp, dynamicTicks = TRUE)
# hg_ply <- ggplotly(hgp, dynamicTicks = TRUE)
# subplot(hm_ply, hg_ply, nrows = 2, shareX = TRUE, titleY = TRUE)
```