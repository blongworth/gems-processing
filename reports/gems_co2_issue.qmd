```{r}
#| echo: false
#| message: false
#| warning: false
library(targets)
library(dplyr)
library(lubridate)
library(gemstools)
library(ggplot2)
library(plotly)
library(patchwork)
library(here)

# Configure targets to look in parent directory
tar_config_set(store = here("_targets"))

tar_load(rga_adv_flux)
tar_load(hourly_stats)
tar_load(rga_oxygen)
tar_load(seaphox_df_jul)
tar_load(proco2_df_jul)
```


## CO2 flux magnitude issue

Comparison of CO2 and O2 gradient


```{r}
cgp <- hourly_stats |> 
  ggplot(aes(solar_hour, co2_gradient_umol_l_m_hourly)) +
  geom_line() +
  geom_ribbon(aes(ymin = co2_gradient_umol_l_m_hourly - co2_gradient_umol_l_m_hourly_sd,
                  ymax = co2_gradient_umol_l_m_hourly + co2_gradient_umol_l_m_hourly_sd),
              alpha = 0.2) +
  labs(x = "Hour of Day",
       y = "CO2 Gradient [mmol/m4]")

hgp / cgp
```

Compare ProCO2 and RGA

```{r}
co2_df <- proco2_df_jul |>
    select(timestamp = ts, prooceanus_co2_ppm = co2, cell_pressure)
co2_cal_df <- dplyr::inner_join(
    co2_df,
    rga_oxygen,
    by = dplyr::join_by(timestamp)
) |>
    mutate(
        prooceanus_co2_umol_l = co2_ppm_to_umol_per_l(
            xco2_ppm = prooceanus_co2_ppm,
            temp_c = adv_temp, # status temp
            sal_psu = 31.425, # mean seaphox salinity
            pressure_mbar = cell_pressure
        )
    )

co2_model <- lm(
    prooceanus_co2_umol_l ~ mass_44_40_high_mean,
    data = co2_cal_df
)

summary(co2_model)
```


Difference in CO2 is related to PAR/time of day

```{r}
ggplot(co2_cal_df, aes(prooceanus_co2_umol_l, mass_44_40_high_mean, color = par)) +
  geom_point()
```

```{r}
co2_i <- coef(co2_model)[1]
co2_m <- coef(co2_model)[2]

co2_cal_df |>
    mutate(
        co2_high_umol_l = co2_i + co2_m * mass_44_40_high,
        co2_diff = (prooceanus_co2_umol_l - co2_high_umol_l) / prooceanus_co2_umol_l
    ) |>
    ggplot(aes(par, co2_diff, color = adv_temp)) +
    geom_point()
```

pH, O2, CO2

```{r}
co2_min_df <- co2_df |>
  select(timestamp, co2 = prooceanus_co2_ppm) |>
  mutate(timestamp = floor_date(timestamp, unit = "minute")) |>
  group_by(timestamp) |>
    summarize(co2 = mean(co2, na.rm = TRUE))

sp_min_df <- seaphox_df_jul |>
  mutate(timestamp = floor_date(timestamp, unit = "minute")) |>
  group_by(timestamp) |>
    summarize(across(where(is.numeric), \(x) mean(x, na.rm = TRUE)))

sp_co2_df <- left_join(sp_min_df, co2_min_df)
```

```{r}
# Check timestamp overlap
overlap <- intersect(sp_min_df$timestamp, co2_min_df$timestamp)
cat("Number of overlapping timestamps:", length(overlap), "\n")
cat("Total sp_min_df timestamps:", nrow(sp_min_df), "\n")
cat("Total co2_min_df timestamps:", nrow(co2_min_df), "\n")
```

No overlap!

Compare to Ox


```{r}
seaphox_15min <- seaphox_df_jul |>
    mutate(timestamp = lubridate::floor_date(timestamp, "15 minute")) |>
    dplyr::group_by(timestamp) |>
    summarize(across(where(is.numeric), \(x) mean(x, na.rm = TRUE)))

ox_cal_df <- dplyr::left_join(
    seaphox_15min,
    rga_oxygen,
    by = dplyr::join_by(timestamp)
)

ox_model <- lm(seaphox_oxygen_ml_l ~ mass_32_40_high_mean, data = ox_cal_df)
ox_i <- coef(ox_model)[1]
ox_m <- coef(ox_model)[2]

ox_cal_df |>
    mutate(
        oxygen_high = ox_i + ox_m * mass_32_40_high,
        oxygen_low = ox_i + ox_m * mass_32_40_low,
        ox_high_umol_l = o2_ml_l_to_umol_l(oxygen_high, adv_temp)
    )

summary(ox_model)
```

```{r}
ggplot(ox_cal_df, aes(seaphox_oxygen_ml_l, mass_32_40_high_mean, color = par)) +
  geom_point()
```