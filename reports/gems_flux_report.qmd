---
title: "GEMS Flux Report"
format: html
---

Figures for general GEMS reporting and GEMS final report.

```{r}
#| echo: false
#| message: false
#| warning: false
library(targets)
library(dplyr)
library(lubridate)
library(gemstools)
library(ggplot2)
library(plotly)
library(patchwork)
library(here)

theme_set(theme_classic())

# Configure targets to look in parent directory
tar_config_set(store = here("_targets"))

tar_load(c(
  rga_binned,
  hourly_flux,
  hourly_stats,
  monthly_stats,
  rga_oxygen,
  seaphox_df_jul,
  proco2_df_jul
))
```

# RGA timeseries

Oxygen/Argon, colored by inlet

```{r}
e <- ggplot(rga_binned, aes(timestamp, mass_32_40, color = inlet)) +
  geom_line()

p <- ggplotly(e, dynamicTicks = TRUE)
p
```

O2/Ar representative plot
```{r}
rga_binned |>
  filter(
    timestamp > as.POSIXct("2025-07-15 00:00:00"),
    timestamp < as.POSIXct("2025-07-20 00:00:00")
  ) |>
  ggplot(aes(timestamp, mass_32_40, color = inlet)) +
  geom_line() +
  labs(
    title = "Oxygen/Argon ratio at high and low inlets",
    x = NULL,
    y = "Mass 32:40"
  )
```

  ## Intensity
  
  O2, CO2, N2, H2S, CH4.
  15min average for top and bottom inlet
  gradient
  normalized/unnormalized difference
  
  # Calibration
  
  Oxygen

  1:1 plots of fit
  fits over cal time
  
  # Flux
  
```{r}
gop = ggplot(hourly_flux, aes(timestamp, ox_flux)) +
  geom_line()

gcp = ggplot(hourly_flux, aes(timestamp, co2_flux)) +
  geom_line()

gpp = ggplot(hourly_flux, aes(timestamp, par_mean)) +
  geom_line()

gop_ply <- ggplotly(gop, dynamicTicks = TRUE)
gcp_ply <- ggplotly(gcp, dynamicTicks = TRUE)
gpp_ply <- ggplotly(gpp, dynamicTicks = TRUE)

subplot(gop_ply, gcp_ply, gpp_ply, nrows = 3, shareX = TRUE, titleY = TRUE)
```


## Hourly Summary

Daily summary by hour-of-day

```{r}
hmp <- hourly_stats |>
  ggplot(aes(solar_hour, ox_mean_umol_l_mean_mean)) +
  geom_line() +
  geom_pointrange(
    aes(
      ymin = ox_mean_umol_l_mean_mean - ox_mean_umol_l_mean_se,
      ymax = ox_mean_umol_l_mean_mean + ox_mean_umol_l_mean_se
    ),
    size = 0.1,
    # position = position_dodge(width = 0.5)
  ) +
  geom_hline(yintercept = 0) +
  labs(x = NULL, y = "Oxygen Conc. [mmol/m3]")

hgp <- hourly_stats |>
  ggplot(aes(solar_hour, ox_gradient_umol_l_m_mean_mean)) +
  geom_line() +
  geom_pointrange(
    aes(
      ymin = ox_gradient_umol_l_m_mean_mean - ox_gradient_umol_l_m_mean_se,
      ymax = ox_gradient_umol_l_m_mean_mean + ox_gradient_umol_l_m_mean_se
    ),
    size = 0.1,
    # position = position_dodge(width = 0.5)
  ) +
  geom_hline(yintercept = 0) +
  labs(x = "Hour of Day", y = "Oxygen Gradient [mmol/m4]")

flp <- hourly_stats |>
  ggplot(aes(solar_hour, ox_flux_mean)) +
  geom_line() +
  geom_pointrange(
    aes(
      ymin = ox_flux_mean - ox_flux_se,
      ymax = ox_flux_mean + ox_flux_se
    ),
    size = 0.1,
    # position = position_dodge(width = 0.5)
  ) +
  geom_hline(yintercept = 0) +
  labs(x = "Hour of Day", y = "Oxygen Flux [mmol/m2/h]")

parp <- hourly_stats |>
  ggplot(aes(solar_hour, par_mean_mean)) +
  geom_line() +
  labs(x = "Hour of Day", y = "Predicted PAR [mmol/m2]")

hmp / hgp / flp / parp

# hm_ply <- ggplotly(hmp, dynamicTicks = TRUE)
# hg_ply <- ggplotly(hgp, dynamicTicks = TRUE)
# subplot(hm_ply, hg_ply, nrows = 2, shareX = TRUE, titleY = TRUE)
```

## Seasonal variability

Same as above but plotted by season/month

Monthly Oxygen flux

```{r}

monthly_stats <- mutate(monthly_stats, month = as.factor(month))

hmp <- monthly_stats |>
  ggplot(aes(solar_hour, ox_mean_umol_l_mean_mean, color = month)) +
  geom_line() +
  geom_pointrange(
    aes(
      ymin = ox_mean_umol_l_mean_mean - ox_mean_umol_l_mean_se,
      ymax = ox_mean_umol_l_mean_mean + ox_mean_umol_l_mean_se
    ),
    size = 0.1,
    # position = position_dodge(width = 0.5)
  ) +
  geom_hline(yintercept = 0) +
  labs(x = NULL, y = "Oxygen Conc. [mmol/m3]")

hgp <- monthly_stats |>
  ggplot(aes(solar_hour, ox_gradient_umol_l_m_mean_mean, color = month)) +
  geom_line() +
  geom_pointrange(
    aes(
      ymin = ox_gradient_umol_l_m_mean_mean - ox_gradient_umol_l_m_mean_se,
      ymax = ox_gradient_umol_l_m_mean_mean + ox_gradient_umol_l_m_mean_se
    ),
    size = 0.1,
    # position = position_dodge(width = 0.5)
  ) +
  geom_hline(yintercept = 0) +
  labs(x = "Hour of Day", y = "Oxygen Gradient [mmol/m4]")

flp <- monthly_stats |>
  ggplot(aes(solar_hour, ox_flux_mean, color = month)) +
  geom_line() +
  geom_pointrange(
    aes(
      ymin = ox_flux_mean - ox_flux_se,
      ymax = ox_flux_mean + ox_flux_se
    ),
    size = 0.1,
    # position = position_dodge(width = 0.5)
  ) +
  geom_hline(yintercept = 0) +
  labs(x = "Hour of Day", y = "Oxygen Flux [mmol/m2/h]")

parp <- monthly_stats |>
  ggplot(aes(solar_hour, par_mean_mean, color = month)) +
  geom_line() +
  labs(x = "Hour of Day", y = "Predicted PAR [mmol/m2]")

hmp / hgp / flp / parp

# hm_ply <- ggplotly(hmp, dynamicTicks = TRUE)
# hg_ply <- ggplotly(hgp, dynamicTicks = TRUE)
# subplot(hm_ply, hg_ply, nrows = 2, shareX = TRUE, titleY = TRUE)
```

# CO2

Comparison of CO2 and O2 gradient

```{r}

hgp <- hourly_stats |>
  ggplot(aes(solar_hour, ox_gradient_umol_l_m_mean_mean)) +
  geom_line() +
  geom_pointrange(
    aes(
      ymin = ox_gradient_umol_l_m_mean_mean - ox_gradient_umol_l_m_mean_se,
      ymax = ox_gradient_umol_l_m_mean_mean + ox_gradient_umol_l_m_mean_se
    ),
    size = 0.1,
    # position = position_dodge(width = 0.5)
  ) +
  geom_hline(yintercept = 0) +
  labs(x = "Hour of Day", y = "Oxygen Gradient [mmol/m4]")

cgp <- hourly_stats |>
  ggplot(aes(solar_hour, co2_gradient_umol_l_m_mean_mean)) +
  geom_line() +
  geom_pointrange(
    aes(
      ymin = co2_gradient_umol_l_m_mean_mean -
        co2_gradient_umol_l_m_mean_se,
      ymax = co2_gradient_umol_l_m_mean_mean +
        co2_gradient_umol_l_m_mean_se
    ),
    size = 0.1,
    # position = position_dodge(width = 0.5)
  ) +
  geom_hline(yintercept = 0) +
  labs(x = "Hour of Day", y = "CO2 Gradient [mmol/m4]")

hgp / cgp
```

# Flux barplots

monthly NEM of diel curves
Include light, temp

# Eelgrass growth figures

## mass

## count

## length

# Synthesis figures

flux vs light, growth, temp
